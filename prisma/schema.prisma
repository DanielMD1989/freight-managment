// This is your Prisma schema file for Freight Management Platform MVP
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  SHIPPER         // Posts loads, searches trucks
  CARRIER         // Posts trucks, searches loads
  DISPATCHER      // Assigns loads, handles exceptions
  ADMIN           // Verifies users, manages wallets, configures rules
  SUPER_ADMIN     // Platform owner, assigns roles, full access
}

enum UserStatus {
  REGISTERED           // Just registered, documents not yet uploaded
  PENDING_VERIFICATION // Documents uploaded, awaiting admin review
  ACTIVE              // Verified and approved, can access marketplace
  SUSPENDED           // Temporarily suspended by admin
  REJECTED            // Registration rejected by admin
}

enum OrganizationType {
  SHIPPER
  CARRIER_COMPANY
  CARRIER_INDIVIDUAL
  LOGISTICS_AGENT
}

enum LoadStatus {
  // Sprint 3: Complete Load Lifecycle State Machine
  DRAFT              // Load created but not yet posted
  POSTED             // Load posted to marketplace, carriers can search
  SEARCHING          // Actively being matched with carriers
  OFFERED            // Load offered to a specific carrier
  ASSIGNED           // Carrier accepted, load assigned
  PICKUP_PENDING     // Waiting for carrier to pick up load
  IN_TRANSIT         // Load picked up, in transit to destination
  DELIVERED          // Load delivered to destination
  COMPLETED          // POD uploaded, payment processed
  EXCEPTION          // Issue detected (late, rejected, etc.)
  CANCELLED          // Load cancelled by shipper
  EXPIRED            // Load expired (no carrier found)
  UNPOSTED           // Load removed from marketplace
}

enum TruckType {
  FLATBED
  REFRIGERATED
  TANKER
  CONTAINER
  DRY_VAN
  LOWBOY
  DUMP_TRUCK
  BOX_TRUCK
}

enum LoadType {
  FULL
  PARTIAL
}

enum BookMode {
  REQUEST
  INSTANT
}

enum AccountType {
  SHIPPER_WALLET
  CARRIER_WALLET
  ESCROW
  PLATFORM_REVENUE
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  COMMISSION
  SETTLEMENT
  ESCROW_FUND
  ESCROW_RELEASE
  REFUND
}

enum DisputeStatus {
  OPEN
  UNDER_REVIEW
  RESOLVED
  CLOSED
}

enum DisputeType {
  PAYMENT_ISSUE
  DAMAGE
  LATE_DELIVERY
  QUALITY_ISSUE
  OTHER
}

enum ReportStatus {
  NEW
  REVIEWED
  ACTIONED
  DISMISSED
}

enum ReportType {
  FRAUD
  HARASSMENT
  SPAM
  SAFETY_VIOLATION
  OTHER
}

enum DocumentType {
  BOL // Bill of Lading
  POD // Proof of Delivery
  INVOICE
  RECEIPT
  INSURANCE
  PERMIT
  OTHER
}

enum GpsDeviceStatus {
  ACTIVE
  INACTIVE
  SIGNAL_LOST
  MAINTENANCE
}

// ============================================================================
// SPRINT 8: NEW ENUMS FOR TRUCK POSTING & MATCHING
// ============================================================================

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

enum PostingStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  MATCHED
}

enum LocationType {
  CITY
  TOWN
  VILLAGE
  LANDMARK
}

// SPRINT 14: DAT-Style UI - Saved Search Type
enum SearchType {
  LOADS
  TRUCKS
}

enum CompanyDocumentType {
  COMPANY_LICENSE
  TIN_CERTIFICATE
  BUSINESS_REGISTRATION
  TRADE_LICENSE
  VAT_CERTIFICATE
  OTHER
}

enum TruckDocumentType {
  TITLE_DEED
  REGISTRATION
  INSURANCE
  ROAD_WORTHINESS
  DRIVER_LICENSE
  OTHER
}

// ============================================================================
// PHASE 2: MATCHING & AUTHORITY ENUMS
// Foundation Rules: DISPATCHER_COORDINATION_ONLY, CARRIER_FINAL_AUTHORITY
// ============================================================================

// Dispatcher match proposal status
enum ProposalStatus {
  PENDING      // Proposal created, awaiting carrier review
  ACCEPTED     // Carrier accepted the proposal
  REJECTED     // Carrier rejected the proposal
  EXPIRED      // Proposal expired without response
  CANCELLED    // Dispatcher cancelled the proposal
}

// Shipper truck request status
enum RequestStatus {
  PENDING      // Request created, awaiting carrier approval
  APPROVED     // Carrier approved the request
  REJECTED     // Carrier rejected the request
  EXPIRED      // Request expired without response
  CANCELLED    // Shipper cancelled the request
}

// ============================================================================
// CORE MODELS
// ============================================================================

model User {
  id                String     @id @default(cuid())
  email             String     @unique
  phone             String?    @unique
  passwordHash      String
  firstName         String?
  lastName          String?
  role              UserRole   @default(SHIPPER)
  status            UserStatus @default(REGISTERED) // Sprint 2: User verification workflow
  isEmailVerified   Boolean    @default(false)
  isPhoneVerified   Boolean    @default(false)
  isActive          Boolean    @default(true) // DEPRECATED: Use status field instead
  lastLoginAt       DateTime?
  notificationPreferences Json?  // PHASE 2: Story 15.13 - User notification preferences
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  // Relations
  organizationId    String?
  organization      Organization? @relation(fields: [organizationId], references: [id])

  loadsCreated      Load[]    @relation("LoadCreator")
  disputes          Dispute[]
  reports           Report[]
  passwordResetTokens PasswordResetToken[]
  savedSearches     SavedSearch[]  // SPRINT 14: DAT-Style UI
  notifications     Notification[] // SPRINT 16: Story 16.10 - Notifications

  // PHASE 2: Match proposal and request relations
  proposalsCreated      MatchProposal[]  @relation("ProposedBy")
  proposalsResponded    MatchProposal[]  @relation("RespondedBy")
  requestsCreated       TruckRequest[]   @relation("RequestedBy")
  requestsResponded     TruckRequest[]   @relation("RespondedByCarrier")

  @@index([email])
  @@index([organizationId])
  @@map("users")
}

model PasswordResetToken {
  id          String   @id @default(cuid())
  token       String   @unique
  expiresAt   DateTime
  usedAt      DateTime?
  createdAt   DateTime @default(now())

  // Relations
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("password_reset_tokens")
}

model Organization {
  id                String           @id @default(cuid())
  name              String
  type              OrganizationType
  description       String?
  contactEmail      String
  contactPhone      String
  address           String?
  city              String?
  isVerified        Boolean          @default(false)
  verifiedAt        DateTime?
  licenseNumber     String?
  taxId             String?
  allowNameDisplay  Boolean          @default(true)  // SPRINT 14: Company masking preference

  // SPRINT 16: Story 16.5 - Trust & Reliability Metrics
  completionRate    Decimal?         @default(0)     // % of loads completed successfully
  cancellationRate  Decimal?         @default(0)     // % of loads cancelled
  disputeRate       Decimal?         @default(0)     // % of loads with disputes
  totalLoadsCompleted Int            @default(0)     // Total loads delivered
  totalLoadsCancelled Int            @default(0)     // Total loads cancelled
  totalDisputes     Int              @default(0)     // Total disputes filed

  // SPRINT 16: Story 16.6 - Anti-Bypass Detection
  suspiciousCancellationCount Int    @default(0)     // Cancellations after contact view
  bypassAttemptCount Int             @default(0)     // Reported bypass attempts
  isFlagged         Boolean          @default(false) // Flagged for suspicious activity
  flaggedAt         DateTime?                        // When flagged
  flagReason        String?                          // Reason for flagging

  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  // Relations
  users             User[]
  loads             Load[]
  trucks            Truck[]
  financialAccounts FinancialAccount[]
  disputesAgainst   Dispute[]         @relation("DisputedOrganization")

  // SPRINT 8: New relations
  documents         CompanyDocument[]
  truckPostings     TruckPosting[]

  // PHASE 2: Match proposal and request relations
  matchProposals    MatchProposal[]
  shipperRequests   TruckRequest[]   @relation("ShipperRequests")
  carrierRequests   TruckRequest[]   @relation("CarrierRequests")

  @@index([type])
  @@index([isVerified])
  @@map("organizations")
}

// ============================================================================
// MARKETPLACE MODELS
// ============================================================================

model Load {
  id                    String      @id @default(cuid())
  status                LoadStatus  @default(DRAFT)
  postedAt              DateTime?

  // Location & Schedule
  pickupCity            String?     // SPRINT 8: Made nullable, use pickupCityId
  pickupCityId          String?     // SPRINT 8: FK to EthiopianLocation
  pickupAddress         String?
  pickupDockHours       String?     // Changed from DateTime to String for "8:00 AM - 5:00 PM" format
  pickupDate            DateTime
  appointmentRequired   Boolean     @default(false)

  deliveryCity          String?     // SPRINT 8: Made nullable, use deliveryCityId
  deliveryCityId        String?     // SPRINT 8: FK to EthiopianLocation
  deliveryAddress       String?
  deliveryDockHours     String?     // Changed from DateTime to String for "8:00 AM - 5:00 PM" format
  deliveryDate          DateTime

  // [NEW] Logistics & Distance
  tripKm                Decimal?    // Required when status = POSTED (legacy - use estimatedTripKm)
  estimatedTripKm       Decimal?    // SPRINT 16: Estimated trip distance from map
  dhToOriginKm          Decimal?    // Deadhead to origin
  dhAfterDeliveryKm     Decimal?    // Deadhead after delivery
  originLat             Decimal?
  originLon             Decimal?
  destinationLat        Decimal?
  destinationLon        Decimal?

  // Load Details
  truckType             TruckType
  weight                Decimal     // in kg
  volume                Decimal?    // in cubic meters
  cargoDescription      String
  isFullLoad            Boolean     @default(true)  // Keep for backward compatibility
  fullPartial           LoadType?   @default(FULL)  // [NEW] FULL | PARTIAL
  isFragile             Boolean     @default(false)
  requiresRefrigeration Boolean     @default(false)

  // [NEW] Cargo Details
  lengthM               Decimal?    // Cargo length in meters
  casesCount            Int?        // Number of cases/pallets

  // Pricing - SPRINT 16: Base + Per-KM Model
  baseFareEtb           Decimal?    // Base fare component (ETB)
  perKmEtb              Decimal?    // Per-kilometer rate (ETB/km)
  totalFareEtb          Decimal?    // Calculated: baseFareEtb + (estimatedTripKm Ã— perKmEtb)
  actualTripKm          Decimal?    // GPS-computed actual trip distance (Phase 2)

  // Legacy pricing field (deprecated - use baseFareEtb + perKmEtb instead)
  rate                  Decimal     // in ETB - DEPRECATED: Use totalFareEtb
  currency              String      @default("ETB")
  bookMode              BookMode?   @default(REQUEST)  // [NEW] REQUEST | INSTANT

  // SPRINT 8: Market pricing removed per TRD requirements
  // dtpReference and factorRating removed - use per-km pricing instead

  // Privacy & Safety
  isAnonymous           Boolean     @default(false)
  shipperContactName    String?     // [NEW] Hidden until assignment
  shipperContactPhone   String?     // [NEW] Hidden until assignment
  safetyNotes           String?
  specialInstructions   String?

  // Escrow & Finance
  escrowFunded          Boolean     @default(false)
  escrowAmount          Decimal?
  shipperCommission     Decimal?
  carrierCommission     Decimal?
  platformCommission    Decimal?

  // SPRINT 16: Story 16.7 - Commission & Settlement
  podUrl                String?                      // Proof of Delivery document URL
  podSubmitted          Boolean     @default(false)  // POD uploaded by carrier
  podSubmittedAt        DateTime?                    // When POD was uploaded
  podVerified           Boolean     @default(false)  // POD verified by shipper
  podVerifiedAt         DateTime?                    // When POD was verified
  settlementStatus      String?     @default("PENDING") // PENDING, IN_PROGRESS, PAID, DISPUTED
  settledAt             DateTime?                    // When commission was deducted

  // Assignment
  assignedTruckId       String?     @unique
  assignedAt            DateTime?

  // SPRINT 14: DAT-Style UI - Status tracking
  isKept                Boolean     @default(false)  // Star/favorite
  hasAlerts             Boolean     @default(false)  // Bell icon
  groupId               String?                      // GROUP tab

  // SPRINT 16: GPS Live Tracking (Story 16.3)
  trackingUrl           String?     @unique          // Unique shareable tracking URL
  trackingEnabled       Boolean     @default(false)  // GPS tracking active
  trackingStartedAt     DateTime?                    // When tracking began

  // SPRINT 16: Story 16.6 - Anti-Bypass Detection
  contactViewedAt       DateTime?                    // When contact info was viewed
  bypassReported        Boolean     @default(false)  // Bypass attempt reported
  bypassReportedAt      DateTime?                    // When bypass was reported
  bypassReportedBy      String?                      // User ID who reported

  // Tracking
  expiresAt             DateTime?
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt

  // Relations
  shipperId             String
  shipper               Organization @relation(fields: [shipperId], references: [id])

  createdById           String
  createdBy             User         @relation("LoadCreator", fields: [createdById], references: [id])

  assignedTruck         Truck?       @relation(fields: [assignedTruckId], references: [id])

  // SPRINT 8: Location relations
  pickupLocation        EthiopianLocation? @relation("PickupLocation", fields: [pickupCityId], references: [id])
  deliveryLocation      EthiopianLocation? @relation("DeliveryLocation", fields: [deliveryCityId], references: [id])

  documents             Document[]
  events                LoadEvent[]
  disputes              Dispute[]
  journalEntries        JournalEntry[]
  escalations           LoadEscalation[]  // Sprint 4: Dispatcher escalation tracking

  // PHASE 2: Match proposal and request relations
  matchProposals        MatchProposal[]
  truckRequests         TruckRequest[]

  @@index([status])
  @@index([pickupCity])
  @@index([deliveryCity])
  @@index([pickupCityId])   // SPRINT 8: Index for location-based filtering
  @@index([deliveryCityId]) // SPRINT 8: Index for location-based filtering
  @@index([pickupDate])
  @@index([shipperId])
  @@index([truckType])
  @@index([tripKm])        // [NEW] For filtering by trip distance
  @@index([fullPartial])   // [NEW] For filtering by full/partial
  @@index([bookMode])      // [NEW] For filtering by booking mode
  @@index([postedAt])      // [NEW] For age calculation and sorting
  @@index([trackingUrl])   // SPRINT 16: For tracking page lookups
  @@index([trackingEnabled]) // SPRINT 16: For filtering tracked loads
  @@map("loads")
}

model LoadEvent {
  id          String   @id @default(cuid())
  eventType   String   // CREATED, POSTED, UNPOSTED, EDITED, DELETED, ASSIGNED, etc.
  description String?
  metadata    Json?    // Store additional event data
  userId      String?
  createdAt   DateTime @default(now())

  // Relations
  loadId      String
  load        Load     @relation(fields: [loadId], references: [id], onDelete: Cascade)

  @@index([loadId])
  @@index([eventType])
  @@map("load_events")
}

// Sprint 4: Dispatcher Escalation System
model LoadEscalation {
  id                String   @id @default(cuid())

  // Escalation Details
  escalationType    EscalationType        // Type of issue
  priority          EscalationPriority    // Severity level
  status            EscalationStatus      @default(OPEN)

  // Description
  title             String                // Short description
  description       String?               // Detailed description
  notes             String?               // Internal notes

  // Resolution
  resolution        String?               // How it was resolved
  resolvedBy        String?               // User ID who resolved
  resolvedAt        DateTime?             // When it was resolved

  // Assignment
  assignedTo        String?               // Dispatcher/admin assigned
  assignedAt        DateTime?             // When it was assigned

  // Tracking
  createdBy         String                // User ID who created
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  loadId            String
  load              Load     @relation(fields: [loadId], references: [id], onDelete: Cascade)

  @@index([loadId])
  @@index([status])
  @@index([priority])
  @@index([escalationType])
  @@index([assignedTo])
  @@map("load_escalations")
}

enum EscalationType {
  LATE_PICKUP          // Carrier late to pickup
  LATE_DELIVERY        // Delivery delayed
  TRUCK_BREAKDOWN      // Mechanical failure
  CARRIER_NO_SHOW      // Carrier didn't show up
  ROUTE_DEVIATION      // Truck went off route
  GPS_OFFLINE          // GPS device offline
  CARGO_DAMAGE         // Cargo damaged
  SHIPPER_ISSUE        // Issue with shipper
  CARRIER_ISSUE        // Issue with carrier
  DOCUMENTATION        // Missing/incorrect documents
  PAYMENT_DISPUTE      // Payment related issue
  BYPASS_DETECTED      // Platform bypass attempt
  OTHER                // Other issues
}

enum EscalationPriority {
  LOW                  // Minor issue, no immediate action needed
  MEDIUM               // Standard issue, should be addressed soon
  HIGH                 // Important issue, needs attention
  CRITICAL             // Urgent issue, immediate action required
}

enum EscalationStatus {
  OPEN                 // New escalation, not yet assigned
  ASSIGNED             // Assigned to dispatcher
  IN_PROGRESS          // Being worked on
  RESOLVED             // Issue resolved
  CLOSED               // Escalation closed
  ESCALATED            // Escalated to higher level
}

model Document {
  id          String       @id @default(cuid())
  type        DocumentType
  fileName    String
  fileUrl     String
  fileSize    Int          // in bytes
  mimeType    String
  description String?
  uploadedAt  DateTime     @default(now())

  // Relations
  loadId      String
  load        Load         @relation(fields: [loadId], references: [id], onDelete: Cascade)

  @@index([loadId])
  @@map("documents")
}

// ============================================================================
// TRUCK & GPS MODELS
// ============================================================================

model Truck {
  id              String      @id @default(cuid())
  truckType       TruckType
  licensePlate    String      @unique
  capacity        Decimal     // in kg
  volume          Decimal?    // in cubic meters
  isAvailable     Boolean     @default(true)
  currentCity     String?
  currentRegion   String?

  // Sprint 6: Current location for DH-O calculations
  currentLocationLat  Decimal?  @db.Decimal(10, 7)  // Current latitude
  currentLocationLon  Decimal?  @db.Decimal(10, 7)  // Current longitude
  locationUpdatedAt   DateTime?                     // When location was last updated

  // SPRINT 8: New fields for truck posting
  lengthM         Decimal?    // Truck bed length in meters
  ownerName       String?     // Explicit owner name
  contactName     String?     // Primary contact
  contactPhone    String?     // Primary contact phone

  // SPRINT 16: GPS Tracking Fields (Story 16.2)
  imei            String?     @unique  // GPS device IMEI (15 digits)
  gpsProvider     String?              // e.g., "Teltonika", "Queclink", "Coban"
  gpsStatus       GpsDeviceStatus?     // ACTIVE, INACTIVE, SIGNAL_LOST
  gpsLastSeenAt   DateTime?            // Last GPS signal received
  gpsVerifiedAt   DateTime?            // When GPS was verified working

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  carrierId       String
  carrier         Organization @relation(fields: [carrierId], references: [id])

  gpsDeviceId     String?      @unique
  gpsDevice       GpsDevice?   @relation(fields: [gpsDeviceId], references: [id])

  assignedLoad    Load?
  gpsPositions    GpsPosition[]

  // SPRINT 8: New relations
  postings        TruckPosting[]
  documents       TruckDocument[]

  // PHASE 2: Match proposal and request relations
  matchProposals  MatchProposal[]
  truckRequests   TruckRequest[]

  @@index([carrierId])
  @@index([truckType])
  @@index([isAvailable])
  @@index([imei])
  @@index([gpsStatus])
  @@map("trucks")
}

model GpsDevice {
  id          String          @id @default(cuid())
  imei        String          @unique
  status      GpsDeviceStatus @default(ACTIVE)
  lastSeenAt  DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  // Relations
  truck       Truck?
  positions   GpsPosition[]

  @@index([imei])
  @@map("gps_devices")
}

model GpsPosition {
  id          String    @id @default(cuid())
  latitude    Decimal   @db.Decimal(10, 7)
  longitude   Decimal   @db.Decimal(10, 7)
  speed       Decimal?  // in km/h
  heading     Decimal?  // in degrees
  altitude    Decimal?  // in meters
  accuracy    Decimal?  // in meters
  timestamp   DateTime  @default(now())

  // SPRINT 16: Story 16.8 - GPS Data Storage
  loadId      String?   // Link to active load (if truck is on a delivery)

  // Relations
  truckId     String
  truck       Truck     @relation(fields: [truckId], references: [id], onDelete: Cascade)

  deviceId    String
  device      GpsDevice @relation(fields: [deviceId], references: [id])

  @@index([truckId, timestamp])
  @@index([deviceId])
  @@index([loadId])         // SPRINT 16: For querying positions by load
  @@map("gps_positions")
}

// ============================================================================
// FINANCIAL MODELS
// ============================================================================

model FinancialAccount {
  id              String      @id @default(cuid())
  accountType     AccountType
  balance         Decimal     @default(0) @db.Decimal(12, 2)
  currency        String      @default("ETB")
  isActive        Boolean     @default(true)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  organizationId  String?
  organization    Organization? @relation(fields: [organizationId], references: [id])

  debitLines      JournalLine[] @relation("DebitAccount")
  creditLines     JournalLine[] @relation("CreditAccount")

  @@index([accountType])
  @@index([organizationId])
  @@map("financial_accounts")
}

// SPRINT 16: Story 16.7 - Commission Configuration
model CommissionRate {
  id                  String   @id @default(cuid())
  shipperRate         Decimal  @default(5.0)  // % of load value (default 5%)
  carrierRate         Decimal  @default(5.0)  // % of load value (default 5%)
  effectiveFrom       DateTime @default(now())
  effectiveTo         DateTime?
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  createdBy           String?  // Admin user ID

  @@index([isActive])
  @@index([effectiveFrom])
  @@map("commission_rates")
}

model JournalEntry {
  id              String          @id @default(cuid())
  transactionType TransactionType
  description     String
  reference       String?         // External reference (payment ID, load ID, etc.)
  metadata        Json?
  createdAt       DateTime        @default(now())

  // Relations
  loadId          String?
  load            Load?           @relation(fields: [loadId], references: [id])

  lines           JournalLine[]

  @@index([transactionType])
  @@index([loadId])
  @@map("journal_entries")
}

model JournalLine {
  id              String           @id @default(cuid())
  amount          Decimal          @db.Decimal(12, 2)
  isDebit         Boolean          // true = debit, false = credit
  createdAt       DateTime         @default(now())

  // Relations
  journalEntryId  String
  journalEntry    JournalEntry     @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)

  accountId       String
  account         FinancialAccount @relation(fields: [accountId], references: [id], name: "DebitAccount")
  creditAccountId String?
  creditAccount   FinancialAccount? @relation(fields: [creditAccountId], references: [id], name: "CreditAccount")

  @@index([journalEntryId])
  @@index([accountId])
  @@map("journal_lines")
}

model PaymentExternal {
  id              String   @id @default(cuid())
  provider        String   // CHAPA, STRIPE, etc.
  providerTxId    String   @unique
  amount          Decimal  @db.Decimal(12, 2)
  currency        String   @default("ETB")
  status          String   // PENDING, COMPLETED, FAILED
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([providerTxId])
  @@map("payments_external")
}

model WithdrawalRequest {
  id              String   @id @default(cuid())
  amount          Decimal  @db.Decimal(12, 2)
  currency        String   @default("ETB")
  status          String   @default("PENDING") // PENDING, APPROVED, REJECTED, COMPLETED
  bankAccount     String
  bankName        String
  accountHolder   String
  requestedById   String
  approvedById    String?
  approvedAt      DateTime?
  completedAt     DateTime?
  rejectionReason String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([status])
  @@index([requestedById])
  @@map("withdrawal_requests")
}

// ============================================================================
// DISPUTE & REPORTING MODELS
// ============================================================================

model Dispute {
  id              String        @id @default(cuid())
  type            DisputeType
  status          DisputeStatus @default(OPEN)
  description     String
  evidenceUrls    String[]      // Array of file URLs
  resolution      String?
  resolvedAt      DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  loadId          String
  load            Load          @relation(fields: [loadId], references: [id])

  createdById     String
  createdBy       User          @relation(fields: [createdById], references: [id])

  disputedOrgId   String
  disputedOrg     Organization  @relation("DisputedOrganization", fields: [disputedOrgId], references: [id])

  @@index([status])
  @@index([loadId])
  @@map("disputes")
}

model Report {
  id          String       @id @default(cuid())
  type        ReportType
  status      ReportStatus @default(NEW)
  description String
  evidence    String?      // File URL or additional details
  actionTaken String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  reportedById String
  reportedBy   User   @relation(fields: [reportedById], references: [id])

  @@index([status])
  @@map("reports")
}

// ============================================================================
// SYSTEM MODELS
// ============================================================================

model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  updatedAt   DateTime @updatedAt

  @@map("system_config")
}

model AuditLog {
  id        String   @id @default(cuid())

  // Event Information
  eventType String   // AUTH_LOGIN_SUCCESS, FILE_UPLOAD, etc.
  severity  String   // INFO, WARNING, ERROR, CRITICAL

  // User Context
  userId         String?
  organizationId String?

  // Request Context
  ipAddress  String?
  userAgent  String?

  // Resource Information
  resource   String?  // DOCUMENT, FILE, USER, etc.
  resourceId String?  // ID of the resource
  action     String?  // CREATE, UPDATE, DELETE, VERIFY, etc.

  // Result
  result   String   // SUCCESS or FAILURE
  message  String   // Human-readable message
  metadata Json     @default("{}")  // Additional data

  // Timestamp
  timestamp DateTime @default(now())

  // Indexes for common queries
  @@index([userId])
  @@index([organizationId])
  @@index([eventType])
  @@index([severity])
  @@index([timestamp])
  @@index([ipAddress])

  @@map("audit_logs")
}

// ============================================================================
// SPRINT 8: NEW MODELS - TRUCK POSTING & MATCHING
// ============================================================================

model EthiopianLocation {
  id            String       @id @default(cuid())
  name          String       // City/town name in English
  nameEthiopic  String?      // Amharic name
  region        String       // Administrative region
  zone          String?      // Sub-region
  latitude      Decimal      @db.Decimal(10, 7)
  longitude     Decimal      @db.Decimal(10, 7)
  type          LocationType @default(CITY)
  population    Int?
  aliases       String[]     // Alternative spellings for search
  isActive      Boolean      @default(true)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Relations
  loadsPickup         Load[]         @relation("PickupLocation")
  loadsDelivery       Load[]         @relation("DeliveryLocation")
  truckPostingsOrigin TruckPosting[] @relation("OriginCity")
  truckPostingsDest   TruckPosting[] @relation("DestinationCity")

  @@unique([name, region])
  @@index([name])
  @@index([region])
  @@map("ethiopian_locations")
}

model TruckPosting {
  id                          String            @id @default(cuid())
  status                      PostingStatus     @default(ACTIVE)
  
  // Availability
  availableFrom               DateTime
  availableTo                 DateTime?
  
  // Location
  originCityId                String
  originCity                  EthiopianLocation @relation("OriginCity", fields: [originCityId], references: [id])
  destinationCityId           String?
  destinationCity             EthiopianLocation? @relation("DestinationCity", fields: [destinationCityId], references: [id])
  
  // Truck Details
  truckId                     String
  truck                       Truck             @relation(fields: [truckId], references: [id], onDelete: Cascade)
  fullPartial                 LoadType          @default(FULL)
  
  // Capacity
  availableLength             Decimal?
  availableWeight             Decimal?
  
  // Deadhead Preferences (OPTIONAL - for filtering only)
  preferredDhToOriginKm       Decimal?
  preferredDhAfterDeliveryKm  Decimal?
  
  // Contact
  contactName                 String
  contactPhone                String
  
  // Owner
  ownerName                   String?
  
  // Metadata
  notes                       String?
  postedAt                    DateTime          @default(now())
  expiresAt                   DateTime?
  createdAt                   DateTime          @default(now())
  updatedAt                   DateTime          @updatedAt
  
  // Relations
  carrierId                   String
  carrier                     Organization      @relation(fields: [carrierId], references: [id])
  createdById                 String
  
  @@index([status])
  @@index([originCityId])
  @@index([destinationCityId])
  @@index([availableFrom])
  @@index([carrierId])
  @@map("truck_postings")
}

// ============================================================================
// PHASE 2: MATCHING & AUTHORITY MODELS
// Foundation Rules: DISPATCHER_COORDINATION_ONLY, CARRIER_FINAL_AUTHORITY
// ============================================================================

// Dispatcher proposes a match between load and truck
// Carrier must approve before assignment happens
model MatchProposal {
  id                String            @id @default(cuid())
  status            ProposalStatus    @default(PENDING)

  // Load being proposed
  loadId            String
  load              Load              @relation(fields: [loadId], references: [id])

  // Truck being proposed
  truckId           String
  truck             Truck             @relation(fields: [truckId], references: [id])

  // Carrier who owns the truck (must approve)
  carrierId         String
  carrier           Organization      @relation(fields: [carrierId], references: [id])

  // Dispatcher who created the proposal
  proposedById      String
  proposedBy        User              @relation("ProposedBy", fields: [proposedById], references: [id])

  // Proposal metadata
  notes             String?           // Dispatcher's notes for the carrier
  proposedRate      Decimal?          // Suggested rate (optional)

  // Response from carrier
  respondedAt       DateTime?
  responseNotes     String?
  respondedById     String?
  respondedBy       User?             @relation("RespondedBy", fields: [respondedById], references: [id])

  // Expiration
  expiresAt         DateTime

  // Timestamps
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([status])
  @@index([loadId])
  @@index([truckId])
  @@index([carrierId])
  @@index([proposedById])
  @@map("match_proposals")
}

// Shipper requests a specific truck for their load
// Carrier must approve before assignment happens
model TruckRequest {
  id                String            @id @default(cuid())
  status            RequestStatus     @default(PENDING)

  // Load for which truck is requested
  loadId            String
  load              Load              @relation(fields: [loadId], references: [id])

  // Truck being requested
  truckId           String
  truck             Truck             @relation(fields: [truckId], references: [id])

  // Shipper who made the request
  shipperId         String
  shipper           Organization      @relation("ShipperRequests", fields: [shipperId], references: [id])
  requestedById     String
  requestedBy       User              @relation("RequestedBy", fields: [requestedById], references: [id])

  // Carrier who owns the truck (must approve)
  carrierId         String
  carrier           Organization      @relation("CarrierRequests", fields: [carrierId], references: [id])

  // Request metadata
  notes             String?           // Shipper's notes for the carrier
  offeredRate       Decimal?          // Rate shipper is willing to pay

  // Response from carrier
  respondedAt       DateTime?
  responseNotes     String?
  respondedById     String?
  respondedBy       User?             @relation("RespondedByCarrier", fields: [respondedById], references: [id])

  // Expiration
  expiresAt         DateTime

  // Timestamps
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([status])
  @@index([loadId])
  @@index([truckId])
  @@index([shipperId])
  @@index([carrierId])
  @@map("truck_requests")
}

model CompanyDocument {
  id                 String                @id @default(cuid())
  type               CompanyDocumentType
  fileName           String
  fileUrl            String
  fileSize           Int                   // bytes
  mimeType           String
  
  // Verification
  verificationStatus VerificationStatus    @default(PENDING)
  verifiedById       String?
  verifiedAt         DateTime?
  rejectionReason    String?
  
  // Metadata
  uploadedAt         DateTime              @default(now())
  expiresAt          DateTime?             // License expiration
  
  // Relations
  organizationId     String
  organization       Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  uploadedById       String
  
  @@index([organizationId])
  @@index([verificationStatus])
  @@map("company_documents")
}

model TruckDocument {
  id                 String              @id @default(cuid())
  type               TruckDocumentType
  fileName           String
  fileUrl            String
  fileSize           Int
  mimeType           String
  
  // Verification
  verificationStatus VerificationStatus  @default(PENDING)
  verifiedById       String?
  verifiedAt         DateTime?
  rejectionReason    String?
  
  // Metadata
  uploadedAt         DateTime            @default(now())
  expiresAt          DateTime?
  
  // Relations
  truckId            String
  truck              Truck               @relation(fields: [truckId], references: [id], onDelete: Cascade)
  uploadedById       String
  
  @@index([truckId])
  @@index([verificationStatus])
  @@map("truck_documents")
}

// ============================================================================
// SPRINT 14: DAT-STYLE UI MODELS
// ============================================================================

model SavedSearch {
  id        String     @id @default(cuid())
  name      String
  type      SearchType // LOADS or TRUCKS
  criteria  Json       // Flexible search criteria
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // Relations
  userId    String
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@map("saved_searches")
}

// ============================================================================
// SPRINT 16: NOTIFICATION SYSTEM (Story 16.10)
// ============================================================================

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String   // GPS_OFFLINE, POD_SUBMITTED, USER_SUSPENDED, etc.
  title     String
  message   String   @db.Text
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  metadata  Json?    // Additional context (loadId, exceptionId, etc.)

  @@index([userId, read])
  @@index([createdAt])
  @@map("notifications")
}

// ============================================================================
// SPRINT 7: AUTOMATION RULES ENGINE
// ============================================================================

model AutomationRule {
  id               String             @id @default(cuid())
  name             String             // Descriptive name (e.g., "Late Pickup Alert - 2hr Grace")
  description      String?            // Detailed description

  // Rule Type & Configuration
  ruleType         RuleType           // TIME_BASED, GPS_BASED, THRESHOLD_BASED, CUSTOM
  trigger          RuleTrigger        // When to evaluate this rule

  // Conditions (JSON)
  conditions       Json               // Flexible conditions: { field, operator, value, thresholds }
  // Example: { "graceHours": 2, "status": ["ASSIGNED", "PICKUP_PENDING"], "hoursLateForHigh": 4 }

  // Actions (JSON array)
  actions          Json               // Array of actions to execute
  // Example: [{ "type": "CREATE_ESCALATION", "escalationType": "LATE_PICKUP", "priority": "MEDIUM" }]

  // Status & Control
  isEnabled        Boolean            @default(true)
  isSystem         Boolean            @default(false)  // System rules can't be deleted
  priority         Int                @default(0)      // Execution order (higher = first)

  // Scheduling (for ON_SCHEDULE triggers)
  schedulePattern  String?            // Cron-like pattern: "*/5 * * * *" (every 5 minutes)
  lastExecutedAt   DateTime?          // When it was last run
  nextExecutionAt  DateTime?          // When it should run next

  // Metadata
  createdBy        String             // User ID
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  executionCount   Int                @default(0)      // How many times executed
  successCount     Int                @default(0)      // Successful executions
  failureCount     Int                @default(0)      // Failed executions

  // Relations
  executions       AutomationRuleExecution[]

  @@index([ruleType])
  @@index([trigger])
  @@index([isEnabled])
  @@index([nextExecutionAt])
  @@map("automation_rules")
}

model AutomationRuleExecution {
  id               String            @id @default(cuid())

  // Execution Details
  status           ExecutionStatus   // PENDING, RUNNING, COMPLETED, FAILED
  executedAt       DateTime          @default(now())
  completedAt      DateTime?

  // Results
  result           Json?             // Execution result (actions taken, errors, etc.)
  matchedLoads     Int               @default(0)      // How many loads matched
  actionsExecuted  Int               @default(0)      // How many actions executed
  errorMessage     String?           // Error details if failed

  // Relations
  ruleId           String
  rule             AutomationRule    @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([ruleId])
  @@index([status])
  @@index([executedAt])
  @@map("automation_rule_executions")
}

enum RuleType {
  TIME_BASED      // Time-based rules (late pickup, late delivery)
  GPS_BASED       // GPS-based rules (offline, stalled)
  THRESHOLD_BASED // Threshold rules (custom metrics)
  CUSTOM          // Custom JavaScript/logic rules
}

enum RuleTrigger {
  ON_LOAD_CREATED      // When load is created
  ON_LOAD_ASSIGNED     // When load is assigned to carrier
  ON_PICKUP_PENDING    // When load enters PICKUP_PENDING status
  ON_IN_TRANSIT        // When load enters IN_TRANSIT status
  ON_STATUS_CHANGE     // Any status change
  ON_SCHEDULE          // Scheduled execution (cron-like)
  ON_MANUAL            // Manual trigger by admin
}

enum ExecutionStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

// Sprint 10 - Story 10.6: System Configuration
model SystemSettings {
  id                    String    @id @default("system")

  // Rate Limiting Configuration
  rateLimitDocumentUpload  Int   @default(10)    // Per hour per user
  rateLimitTruckPosting    Int   @default(100)   // Per day per carrier
  rateLimitFileDownload    Int   @default(100)   // Per hour per user
  rateLimitAuthAttempts    Int   @default(5)     // Per 15 minutes per IP

  // Match Score Thresholds
  matchScoreMinimum     Int       @default(40)    // Minimum score to show match
  matchScoreGood        Int       @default(70)    // Good match threshold
  matchScoreExcellent   Int       @default(85)    // Excellent match threshold

  // Email Notification Toggles
  emailNotificationsEnabled      Boolean @default(true)
  emailNotifyDocumentApproval    Boolean @default(true)
  emailNotifyDocumentRejection   Boolean @default(true)
  emailNotifyLoadAssignment      Boolean @default(true)
  emailNotifyPodVerification     Boolean @default(true)

  // Platform Fee Configuration (percentages)
  shipperCommissionRate Decimal   @default(5.0)   @db.Decimal(5, 2)
  carrierCommissionRate Decimal   @default(5.0)   @db.Decimal(5, 2)

  // File Upload Limits
  maxFileUploadSizeMb   Int       @default(10)    // Max file size in MB
  maxDocumentsPerEntity Int       @default(20)    // Max documents per entity

  // General Settings
  platformMaintenanceMode    Boolean  @default(false)
  platformMaintenanceMessage String?
  requireEmailVerification   Boolean  @default(false)
  requirePhoneVerification   Boolean  @default(false)

  // Settlement Automation Settings (Sprint 16 - Story 16.9A)
  settlementAutomationEnabled  Boolean  @default(true)   // Enable/disable auto-settlement
  autoVerifyPodEnabled         Boolean  @default(true)   // Enable/disable auto-POD verification
  autoVerifyPodTimeoutHours    Int      @default(24)     // Hours before auto-verifying POD
  settlementBatchSize          Int      @default(50)     // Max settlements to process per batch
  emailNotifySettlementSuccess Boolean  @default(false)  // Notify admin on successful settlements
  emailNotifySettlementFailure Boolean  @default(true)   // Notify admin on failed settlements
  autoSettlementMinAmount      Decimal  @default(0)      @db.Decimal(10, 2) // Minimum amount for auto-settlement
  autoSettlementMaxAmount      Decimal  @default(0)      @db.Decimal(10, 2) // Maximum amount for auto-settlement (0 = unlimited)

  // Metadata
  lastModifiedBy   String
  lastModifiedAt   DateTime @default(now()) @updatedAt
  createdAt        DateTime @default(now())

  @@map("system_settings")
}
