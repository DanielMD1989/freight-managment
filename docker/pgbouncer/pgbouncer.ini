;; PgBouncer Configuration for Production
;;
;; PHASE 1: Critical Architecture - Connection Pooling for 10K+ DAU
;;
;; This configuration supports:
;; - 100+ concurrent database connections
;; - Connection pooling in transaction mode
;; - 10,000+ daily active users
;;
;; Deployment:
;; 1. Copy this file to /etc/pgbouncer/pgbouncer.ini
;; 2. Create userlist.txt with auth info
;; 3. Start: pgbouncer /etc/pgbouncer/pgbouncer.ini
;;
;; Or use Docker:
;; docker-compose -f docker/docker-compose.pgbouncer.yml up -d

[databases]
;; Database connection definitions
;; Format: dbname = host=hostname port=port dbname=dbname
;;
;; Production database
freight_db = host=${DB_HOST:-localhost} port=${DB_PORT:-5432} dbname=${DB_NAME:-freight_db}

;; For connection string: postgresql://user:pass@localhost:6432/freight_db

[pgbouncer]
;; =============================================================================
;; LISTEN SETTINGS
;; =============================================================================

;; PgBouncer listens on this address
listen_addr = 0.0.0.0

;; PgBouncer listens on this port (different from PostgreSQL default 5432)
listen_port = 6432

;; =============================================================================
;; AUTHENTICATION
;; =============================================================================

;; Authentication type: md5, scram-sha-256, plain, trust
auth_type = scram-sha-256

;; Path to the authentication file
auth_file = /etc/pgbouncer/userlist.txt

;; HBA-style auth file (optional)
; auth_hba_file = /etc/pgbouncer/pg_hba.conf

;; =============================================================================
;; POOL SETTINGS (Critical for 10K+ DAU)
;; =============================================================================

;; Pool mode: session, transaction, or statement
;; - session: Traditional mode, connection assigned until client disconnects
;; - transaction: Connection returned after each transaction (recommended)
;; - statement: Most aggressive, not suitable for multi-statement transactions
pool_mode = transaction

;; Maximum number of connections per user+database pair
;; This is the CRITICAL setting for scaling
;; Formula: (10K DAU / 100 concurrent) * 1.5 safety margin = 150
default_pool_size = 100

;; Maximum number of connections allowed for all pools combined
;; Should match or exceed PostgreSQL max_connections
max_client_conn = 1000

;; Minimum connections to keep ready per pool
min_pool_size = 10

;; How many connections to add when pool is too small
reserve_pool_size = 25

;; Time to wait for a connection from the pool (seconds)
reserve_pool_timeout = 5

;; How long to wait for client to connect (seconds)
client_login_timeout = 60

;; =============================================================================
;; QUERY SETTINGS
;; =============================================================================

;; Disable simple query protocol (more secure)
; ignore_startup_parameters = extra_float_digits

;; Maximum query wait time before giving up (seconds)
query_wait_timeout = 120

;; Maximum time queries are allowed to run (seconds, 0 = unlimited)
query_timeout = 30

;; Cancel long-running queries on client disconnect
cancel_wait_timeout = 10

;; =============================================================================
;; CONNECTION SETTINGS
;; =============================================================================

;; Server connection lifetime (seconds, 0 = unlimited)
;; Connections older than this are closed after use
server_lifetime = 3600

;; Close server connections after being idle this long (seconds)
server_idle_timeout = 600

;; Close client connections after being idle this long (seconds)
client_idle_timeout = 0

;; Verify server connection is alive before use
server_check_query = SELECT 1

;; How often to check server connection (seconds)
server_check_delay = 30

;; =============================================================================
;; LOGGING
;; =============================================================================

;; Log file location
logfile = /var/log/pgbouncer/pgbouncer.log

;; PID file location
pidfile = /var/run/pgbouncer/pgbouncer.pid

;; Admin database name
admin_users = postgres

;; Stats users (can view statistics)
stats_users = postgres

;; Log connections (useful for debugging, disable in high-traffic production)
log_connections = 0

;; Log disconnections
log_disconnections = 0

;; Log pool activity
log_pooler_errors = 1

;; Logging verbosity
verbose = 0

;; =============================================================================
;; TLS/SSL (Enable for production)
;; =============================================================================

;; Client-side TLS
; client_tls_sslmode = prefer
; client_tls_key_file = /etc/pgbouncer/server.key
; client_tls_cert_file = /etc/pgbouncer/server.crt
; client_tls_ca_file = /etc/pgbouncer/ca.crt

;; Server-side TLS (to PostgreSQL)
; server_tls_sslmode = prefer
; server_tls_ca_file = /etc/pgbouncer/ca.crt

;; =============================================================================
;; PERFORMANCE TUNING
;; =============================================================================

;; Number of DNS resolver threads
dns_max_ttl = 15

;; SO_REUSEPORT for better load distribution
so_reuseport = 1

;; TCP keepalive settings
tcp_keepalive = 1
tcp_keepcnt = 3
tcp_keepidle = 60
tcp_keepintvl = 10
